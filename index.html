<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mode Solo Drakerion TCG Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS Global --- */
        body {
            font-family: 'Cinzel', serif; 
            margin: 20px;
            color: #f0f0f0;
            background-image: url('https://cdnb.artstation.com/p/assets/images/images/065/376/977/large/oscar-fayemendie-drakerion-illustration-oscar.jpg?1690222795');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            background-color: #121212;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(30, 30, 30, 0.95); 
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            /* Bordure bleue retir√©e */ 
        }
        .header-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        h1, h2, h3 {
            color: #5bc0de;
        }
        h1 {
            font-size: 2em;
            margin: 0;
        }
        
        #iaMainArea h2 {
            font-size: 1.4em; 
            margin-bottom: 20px;
        }

        /* --- COMPTEURS (CONTAINER) --- */
        .counter-section {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            padding: 15px;
            /* Bordure jaune/or conserv√©e */
            border: 1px solid #f0ad4e; 
            border-radius: 8px;
            min-height: 250px; 
        }
        
        /* --- Conteneurs individuels des compteurs --- */
        .counter {
            text-align: center;
            display: flex; 
            flex-direction: column; 
            flex: 1; 
        }

        .value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        /* Conteneur pour les boutons du bas qui doivent s'aligner */
        .align-bottom-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: auto; 
        }
        
        /* --- Boutons G√©n√©raux (Style 3D) --- */
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            background-color: #f0f0f0;
            color: #1e1e1e;
            box-shadow: 0 4px 0 0 #a0a0a0; 
            transition: all 0.05s ease; 
        }
        button:active {
            box-shadow: 0 0 0 0 #a0a0a0; 
            transform: translateY(4px); 
        }
        button:disabled {
            background-color: #7a7a7a;
            color: #ccc;
            box-shadow: 0 4px 0 0 #555;
            cursor: not-allowed;
            transform: none;
        }
        button:disabled:active {
            box-shadow: 0 4px 0 0 #555;
            transform: none;
        }
        
        /* R√©initialisation g√©n√©rale des styles des boutons dans les compteurs */
        .counter button {
            font-size: 1.1em; 
            box-sizing: border-box;
        }

        /* *** CORRECTION: Taille uniforme pour les 6 boutons de l'Or *** */
        .counter-gold button {
            width: 45px;      
            height: 45px;     
            line-height: 1;   
            padding: 0;       
            margin: 5px;
        }
        
        /* Boutons +X d'Or (align√©s en grille) */
        .quick-increment-row {
            display: flex;
            justify-content: center;
            margin-top: 5px;
        }
        
        /* La ligne d'increment/decrement de base (pour l'alignement) */
        .counter-gold-inc-dec { 
            display: flex;
            justify-content: center;
        }
        
        /* --- Boutons Sp√©cifiques --- */
        #actionBtn {
            background-color: #d9534f;
            color: white;
            box-shadow: 0 4px 0 0 #953734; 
        }
        #resetBtn {
            background-color: #5cb85c;
            color: white;
            padding: 8px 12px;
            font-size: 0.8em;
            margin: 0; 
            box-shadow: 0 4px 0 0 #3d793d; 
        }
        #declareCombatBtn {
            background-color: #f0ad4e;
            color: #1e1e1e;
            box-shadow: 0 4px 0 0 #ad8741; 
        }
        /* Bouton FIN DE COMBAT */
        #endCombatBtn {
            width: 100%; 
            margin-top: 5px;
            background-color: #337ab7;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 0 0 #205c8a; 
            margin-left: 0;
            margin-right: 0;
        }
        
        /* Bouton AIDE */
        #rulesBtn {
            padding: 8px 12px;
            font-size: 0.8em;
            margin-top: 5px; 
            background-color: #5cb85c;
            color: white;
            box-shadow: 0 4px 0 0 #3d793d;
            width: 80%; 
        }
        
        /* Styles pour le bouton Bonus */
        #bonusActionBtn {
            width: 90%; 
            padding: 8px 10px;
            font-size: 0.85em; 
            background-color: #5bc0de; 
            color: #1e1e1e;
            box-shadow: 0 4px 0 0 #3d8ba6;
        }
        
        /* Boutons +1/-1 Prestige */
        .prestige-buttons {
            display: flex;
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 0px; 
            margin-bottom: 5px; 
            width: 100%; 
        }
        .prestige-buttons button {
             width: 45px;      
             height: 45px;     
             padding: 0;       
             line-height: 1;   
             margin: 5px 0; 
             min-width: 45px; 
        }
        
        /* Pour le conteneur du bouton Bonus (pour aligner en bas) */
        .bonus-action-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: auto; 
            width: 100%; 
        }
        
        /* Bouton "+" du Tour pour le rendre carr√© (45x45 pour √™tre coh√©rent) */
        .counter-turn > button:first-of-type { 
            width: 45px; 
            height: 45px; 
            line-height: 1; 
            margin: 5px auto; 
            padding: 0; 
        }


        /* --- R√©sultat et Combat --- */
        .action-buttons-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .action-buttons-group button {
            flex: 1;
            margin: 0;
            font-size: 1.1em;
        }
        
        /* --- Cadre G√©n√©ral des R√©sultats D'Action --- */
        .action-result {
            padding: 15px;
            background-color: #2c3e50;
            /* Bordure compl√®te conserv√©e */
            border: 1px solid #5bc0de; 
            border-radius: 5px;
            min-height: 50px;
            color: #f0f0f0;
            text-align: center; 
            font-weight: bold;  
        }
        
        .action-result p {
            text-align: center; 
            font-weight: bold;
            margin: 0; 
        }
        
        /* Style pour les cadres rouges (alertes de combat) */
        .combat-alert {
            background-color: #cc0000 !important;
            color: white !important;
            box-shadow: 0 0 0 3px #f0ad4e; 
            border: 2px solid #f0ad4e !important; 
        }
        
        /* --- CORRECTION FLEXIBILIT√â DES COLONNES DE COMBAT/ACTION --- */
        .combat-flex-row {
            display: flex;
            gap: 10px; 
            margin-bottom: 10px;
        }

        .combat-column {
            flex: 1; 
            min-width: 0; 
        }

        /* Encapsulation du module de combat/action pour la coh√©rence visuelle */
        #actionResultContainer > div, #combatModule > div {
             width: 100%;
             box-sizing: border-box; 
             margin-bottom: 5px;
        }

        /* Ajustement du bouton FIN DE COMBAT pour qu'il ne soit pas un flex-item de la colonne */
        #actionResultContainer {
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
        }
        
        /* NOUVEAU STYLE : Centrage des titres de combat */
        .combat-titles-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        /* Centrage du titre de gauche (Action R√©alis√©e) */
        .title-column-left {
            text-align: center; 
            flex: 1; 
        }

        /* Centrage du titre de droite (Combat Actif) */
        .combat-title {
            text-align: center; 
            flex: 1; 
        }

        /* --- MODAL (R√®gles/Aide) --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background-color: #1e1e1e;
            margin: 5% auto; 
            padding: 25px;
            border: 2px solid #5bc0de;
            width: 80%; 
            max-width: 650px; 
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.7);
        }

        .close-btn {
            color: #5bc0de;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-btn:hover, .close-btn:focus {
            color: #f0f0f0;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* Titre principal de la modale */
        .modal-content h2 {
            color: #d9534f;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        /* Titres de sections dans les onglets (modifi√©) */
        .modal-content h3 {
             color: #f0ad4e; 
             margin-top: 15px;
             margin-bottom: 5px;
             font-size: 1.1em;
        }
        
        .modal-content p, .modal-content ul {
            font-size: 0.95em;
            line-height: 1.6;
            color: #ccc;
        }
        
        .modal-content ul {
             padding-left: 20px;
             margin-top: 5px;
        }
        
        /* Nouvelle classe pour les mots cl√©s en bleu clair */
        .modal-content .highlight {
            color: #5bc0de; 
            font-weight: bold; 
        }

        /* --- Styles Sp√©cifiques aux Onglets --- */
        .tab {
            overflow: hidden;
            border: 1px solid #444;
            background-color: #222;
            border-radius: 5px 5px 0 0;
            display: flex;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 1em;
            flex-grow: 1; 
            color: #ccc;
            box-shadow: none; 
        }
        
        .tab button:hover {
            background-color: #333;
        }

        .tab button.active {
            background-color: #5bc0de;
            color: #1e1e1e;
            font-weight: bold;
        }
        
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #444;
            border-top: none;
            background-color: #1e1e1e;
            height: 400px; 
            overflow-y: auto; 
        }
        /* Affichage du premier onglet par d√©faut */
        #rules-solo { display: block; }

    </style>
</head>
<body>

<div class="container">
    <div class="header-group"> 
        <h1>Mode solo Drakerion TCG</h1>
        <button id="resetBtn" onclick="resetGame()">R√âINITIALISER</button>
    </div>
    
    <div class="counter-section">
        
        <div class="counter counter-gold">
            <h2>ü™ô Or</h2>
            <div id="goldValue" class="value">0</div>
            
            <div class="align-bottom-group"> 
                <div class="counter-gold-inc-dec"> 
                    <button onclick="updateGold(-1)">-1</button>
                    <button onclick="updateGold(1)">+1</button>
                </div>

                <div class="quick-increment-row"> 
                    <button onclick="updateGold(5)">+5</button>
                    <button onclick="updateGold(6)">+6</button>
                </div>

                <div class="quick-increment-row"> 
                    <button onclick="updateGold(7)">+7</button>
                    <button onclick="updateGold(8)">+8</button>
                </div>
            </div>
        </div>
        
        <div class="counter">
            <h2>‚ú® Prestige</h2>
            <div id="prestigeValue" class="value">0</div>
            
            <div class="prestige-buttons">
                <button onclick="updatePrestige(1)">+1</button>
                <button onclick="updatePrestige(-1)">-1</button>
            </div>
            
            <div class="bonus-action-container">
                <button id="bonusActionBtn" onclick="applyBonusAction()">BONUS D'ACTION</button>
            </div>
        </div>

        <div class="counter counter-turn">
            <h2>‚è≥ Tour</h2>
            <div id="turnValue" class="value">1</div>
            
            <button onclick="nextTurn()">+</button>

            <div class="align-bottom-group"> 
                <button id="rulesBtn" onclick="showRules()">AIDE</button>
            </div>
        </div>
        
    </div>
    
    <div id="iaMainArea"> 
        <h2>Pr√™t √† tester ton deck ? Je suis ton adversaire !</h2> 

        <div class="action-buttons-group">
            <button id="actionBtn" onclick="performAppAction()">ACTION (0/10)</button>
            <button id="declareCombatBtn" onclick="startCombat('player')">D√âCLARER UN COMBAT</button>
        </div>
        
        <div class="combat-titles-row" style="display:none;">
            <h3 class="title-column-left">ACTION R√âALIS√âE :</h3>
            <h3 class="combat-title">üî• COMBAT ACTIF üî•</h3>
        </div>
        
        <div class="combat-flex-row" style="display:block;">
            
            <div id="actionResultContainer" class="combat-column">
                <div id="actionResult" class="action-result">
                    <p>Clique sur le bouton ci-dessus pour que l'adversaire virtuel joue son tour.</p>
                </div>
                <button id="endCombatBtn" onclick="endCombat()" style="display:none;">FIN DE COMBAT</button>
            </div>

            <div id="combatModule" class="combat-column" style="display: none;"> 
                <div id="combatActionPlayed" class="action-result combat-alert">
                    <p>Clique ci-dessous</p>
                    <button id="combatBtn" onclick="performCombatAction()">CAPACIT√â DE COMBAT</button>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="rulesModal" class="modal" onclick="if(event.target.id === 'rulesModal') hideRules()">
    <div class="modal-content">
        <span class="close-btn" onclick="hideRules()">&times;</span>
        <h2>Aide et R√®gles du Mode Solo Drakerion</h2>
        <p>
            Cette application a pour but de simuler les actions adverses afin de pouvoir tester vos deck si vous √™tes seuls et abandonn√©s de tous‚Ä¶ <span class="highlight">un bisou ?</span> üòô
            Elle te parlera √† la premi√®re personne du singulier, <span class="highlight">"Je fais X"</span> et te tutoiera.
        </p>
        
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'rules-solo')">R√àGLES SOLO & ADAPT√âES</button>
            <button class="tablinks" onclick="openTab(event, 'fonctionnement-boutons')">EXPLICATION DE L'INTERFACE</button>
        </div>

        <div id="rules-solo" class="tabcontent">
            <h3>Mise en place</h3>
            <ul>
                <li>S√©parez les <span class="highlight">Personnages</span> et les <span class="highlight">Attachements</span> (pour les mettre ensemble) des autres cartes du deck pour faire <span class="highlight">2 decks de pioches distincts</span>.</li>
                <li>Pour les autres cartes (banni√®re, cit√©, man≈ìuvres, cartes de d√©part), respectez la r√®gle de mise en place initiale.</li>
                <li>Ton <span class="highlight">adversaire virtuel</span> n'a <span class="highlight">pas de main</span>.</li>
            </ul>

            <h3>R√®gles adapt√©es pour l'adversaire virtuel</h3>
            <ul>
                <li>Les cartes personnages adverses arrivent en jeu √† l'<span class="highlight">extr√™me gauche</span>. D√©callez l'ensemble des cartes si besoin.</li>
                <li><span class="highlight">Attaque Cibl√©e :</span> Lorsque l'application d√©clare un combat, c'est toujours son combattant le <span class="highlight">plus √† gauche √©tant redress√©</span> qui attaque ton combattant le <span class="highlight">plus √† gauche</span>.</li>
                <li><span class="highlight">Infiltrateur :</span> Lorsqu'un personnage avec infiltrateur t'attaque, la capacit√© <span class="highlight">"Infiltrateur" doit √™tre utilis√©e si possible</span>.</li>
                <li><span class="highlight">Redirection d'Attaque :</span> Lorsqu'une capacit√© redirige une de tes attaques, elle est redirig√©e en priorit√© sur le personnage adjacent c√¥t√© <span class="highlight">droit</span>. S'il n'y a pas de personnage √† droite, elle est redirig√©e c√¥t√© <span class="highlight">gauche</span>.</li>
                <li><span class="highlight">Soin :</span> Lorsqu'un soin est prodigu√©, l'adversaire soigne toujours la carte adjacente c√¥t√© <span class="highlight">droit</span>. S'il ne n√©cessite pas de soins, il passe √† la carte suivante. S'il n'y a pas besoin de soins sur la droite, il fait pareil mais c√¥t√© <span class="highlight">gauche</span>.</li>
                <li><span class="highlight">Capacit√© de Combat :</span> Pendant une phase de combat, chaque joueur ne peut jouer qu'une seule carte Capacit√© de Combat.</li>
            </ul>
        </div>

        <div id="fonctionnement-boutons" class="tabcontent">
            <h3>Les Compteurs</h3>
            <p>
                Les compteurs <span class="highlight">Or / Prestige / Tour</span> vous permettent de simuler ces param√®tres pour votre <span class="highlight">adversaire virtuel</span>.
            </p>
            <p>
                Le bouton <span class="highlight">BONUS D'ACTION</span> (sous Prestige) permet d'octroyer √† l'adversaire un bonus de +1 Or ou +1 Prestige al√©atoirement si <span class="highlight">aucune action</span> n'est r√©alisable lors de la phase d'action de l'<span class="highlight">adversaire virtuel</span>.
            </p>

            <h3>Le bouton ‚ÄúACTION (X/10)‚Äù</h3>
            <p>
                Il simule une action de l'adversaire. Le r√©sultat affich√© est al√©atoire, bas√© sur la pond√©ration de l'<span class="highlight">adversaire virtuel</span>.
            </p>
            <ul>
                <li>Si l'<span class="highlight">adversaire virtuel</span> doit jouer un personnage et qu'il n'a plus assez d'or, placez la carte pioch√©e sous le deck et piochez-en une. R√©p√©tez l'action jusqu'√† ce que la carte pioch√©e puisse √™tre pay√©e (idem avec les √©v√©nements et les attachements).</li>
                <li>Si l'<span class="highlight">adversaire virtuel</span> d√©clare un combat, le <span class="highlight">module de combat</span> appara√Æt.</li>
            </ul>

            <h3>Le module de Combat</h3>
            <ul>
                <li><span class="highlight">D√âCLARER UN COMBAT</span> : Permet de d√©clarer un combat √† l'<span class="highlight">adversaire virtuel</span>. Le d√©roulement du combat est identique.</li>
                <li><span class="highlight">CAPACIT√â DE COMBAT</span> : Simule la r√©ponse de l'adversaire virtuel lors d'un combat (√©v√©nement, intercepteur ou passage). Ce bouton se d√©sactive apr√®s chaque utilisation de l'adversaire virtuel.</li>
                <li><span class="highlight">FIN DE COMBAT</span> : Permet de cl√¥turer le combat √† l‚Äô√©cran. Il est d√©sactiv√© tant que l'adversaire virtuel n'a pas r√©pondu au moins une fois via <span class="highlight">CAPACIT√â DE COMBAT</span> apr√®s ton action ou le d√©but du combat.</li>
            </ul>
            
            <h3>Autres Boutons</h3>
            <ul>
                 <li><span class="highlight">R√âINITIALISER</span> : Remet l‚Äôinterface (Or, Prestige, Tour) √† z√©ro.</li>
            </ul>
        </div>
    </div>
</div>


<script>
    // Variables pour les compteurs
    let gold = 0;
    let prestige = 0;
    let turn = 0; 

    // Variables de gestion des contraintes du tour (utilis√©es pour la logique pond√©r√©e)
    let iaActionCount = 0;
    let maneuverUsed = false;
    let cityUsed = false; 
    
    // Drapeaux et Historique pour le combat
    let firstCombatActionPlayed = false; 
    let combatActionHistory = []; 
    let iaInitiatedCombat = false; // Permet de savoir qui a lanc√© le combat
    
    // Historique pour les actions hors combat (pour √©viter 3 r√©p√©titions cons√©cutives)
    let appActionHistory = []; 
    
    // NOUVELLE VARIABLE pour la contrainte de l'Or √† z√©ro. -1 = inactive, >0 = nombre d'actions restantes avant le Pass Forc√© garanti.
    let actionsUntilForcedPass = -1; 
    
    // Liste des actions de base et leurs Poids
    const baseActions = {
        "Je joue une carte personnage/attachement.": 4, 
        "Je d√©clare un combat !": 4,
        "j'active une capacit√© 'action' de la 1√®re carte sur ma gauche. Si elle n'en poss√®de pas, active celle de la carte voisine jusqu'√† ce qu'une action soit faite": 2,
        "j'active une capacit√© 'action' de la 1√®re carte sur ma droite. Si elle n'en poss√®de pas, active celle de la carte voisine jusqu'√† ce qu'une action soit faite": 2,
        "je passe.": 1,
    };

    // Liste des actions sp√©cifiques au Combat (statique pour la r√©f√©rence)
    const combatActions = [
        "Je joue un √©v√©nement 'Combat'.",
        "Je passe.",
        "J'active un intercepteur s'il j'en ai un redress√© en jeu (si pas, je passe).",
    ];

    // --- Fonctions de mise √† jour des compteurs ---

    function updateGold(amount) {
        gold += amount;
        if (gold < 0) { gold = 0; }
        document.getElementById('goldValue').textContent = gold;
    }

    function updatePrestige(amount) {
        prestige += amount;
        document.getElementById('prestigeValue').textContent = prestige;
    }
    
    // Fonction pour mettre √† jour le texte du bouton ACTION de l'adversaire virtuel
    function updateActionButton() {
        const actionBtn = document.getElementById('actionBtn');
        actionBtn.textContent = `ACTION (${iaActionCount}/${10})`;
        actionBtn.disabled = false;
    }

    // --- NOUVELLE FONCTION : BONUS D'ACTION ---
    function applyBonusAction() {
        const choice = Math.floor(Math.random() * 2); 
        let message = "";

        if (choice === 0) {
            updateGold(1);
            message = "üéÅ Bonus d'Action : +1 Or re√ßu !";
        } else {
            updatePrestige(1);
            message = "‚ú® Bonus d'Action : +1 Prestige gagn√© !";
        }
        
        document.getElementById('actionResult').innerHTML = `<p>${message}</p>`;
        document.getElementById('actionResult').classList.remove('combat-alert'); 
        document.getElementById('actionResult').style.backgroundColor = "#5bc0de"; 
        document.getElementById('actionResult').style.color = "#1e1e1e"; 
    }
    // ------------------------------------------

    // --- Fonctions de gestion du MODAL R√àGLES/AIDE et Onglets ---

    function showRules() {
        document.getElementById('rulesModal').style.display = 'block';
        // S'assurer que le premier onglet est toujours actif lors de l'ouverture
        const defaultTab = document.getElementById('rules-solo');
        if (defaultTab) {
            defaultTab.style.display = "block";
            // R√©activer le bouton de l'onglet par d√©faut (si on a chang√© d'onglet avant de fermer)
             const defaultButton = document.querySelector('.tab button:first-child');
             if (defaultButton) {
                defaultButton.classList.add('active');
                
                // S'assurer que les autres boutons sont d√©sactiv√©s
                const otherButton = document.querySelector('.tab button:last-child');
                if (otherButton) {
                    otherButton.classList.remove('active');
                }
             }
        }
    }

    function hideRules() {
        document.getElementById('rulesModal').style.display = 'none';
    }
    
    // Fonction de gestion du changement d'onglet
    function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        
        // Cacher tous les onglets
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        
        // D√©sactiver le style 'active' sur tous les boutons
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        
        // Afficher l'onglet s√©lectionn√© et activer le bouton
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    // --- Fonctions de Combat et Tour ---

    function startCombat(initiator = 'player') {
        iaInitiatedCombat = (initiator === 'ia');
        
        let combatMessage;
        let combatInstruction;

        if (iaInitiatedCombat) {
            combatMessage = "Je d√©clare un combat !"; 
        } else {
            combatMessage = "Tu d√©clares un combat !"; 
        }
        
        // Message minimaliste pour la colonne de droite, comme demand√©
        combatInstruction = "Clique ci-dessous"; 

        // --- Mise √† jour de l'affichage dans la colonne gauche (Action) ---
        document.getElementById('actionResult').innerHTML = `
            <p style="font-size: 1.2em;"><strong>${combatMessage}</strong></p>
        `;
        document.getElementById('actionResult').classList.add('combat-alert'); 
        
        // --- Affichage des modules de combat et d√©sactivation des boutons principaux ---
        document.querySelector('.combat-titles-row').style.display = 'flex';
        document.querySelector('.combat-flex-row').style.display = 'flex';
        
        document.getElementById('actionBtn').disabled = true; 
        document.getElementById('declareCombatBtn').disabled = true; 
        
        document.getElementById('endCombatBtn').style.display = 'block';
        document.getElementById('endCombatBtn').disabled = true; // D√©sactiv√© jusqu'√† la premi√®re r√©ponse de l'IA
        
        firstCombatActionPlayed = false; 
        combatActionHistory = []; 
        
        // --- Contenu de la colonne droite (Combat) ---
        document.getElementById('combatActionPlayed').innerHTML = 
            `<p style="font-size: 1.2em;"><strong>${combatInstruction}</strong></p>
            <button id="combatBtn" onclick="performCombatAction()">CAPACIT√â DE COMBAT</button>`;

        document.getElementById('combatBtn').disabled = false; 
        document.getElementById('combatModule').style.display = 'block';
    }


    function endCombat() {
        document.getElementById('combatModule').style.display = 'none';
        document.querySelector('.combat-titles-row').style.display = 'none';
        document.querySelector('.combat-flex-row').style.display = 'block';
        document.getElementById('endCombatBtn').style.display = 'none';
        document.getElementById('endCombatBtn').disabled = false; 

        document.getElementById('actionBtn').disabled = false;
        document.getElementById('declareCombatBtn').disabled = false;

        document.getElementById('actionResult').innerHTML = `<p>Combat termin√©.</p>`;
        document.getElementById('actionResult').classList.remove('combat-alert');
        document.getElementById('actionResult').style.backgroundColor = "#2c3e50";
        document.getElementById('actionResult').style.color = "#f0f0f0";
    }

    function nextTurn() {
        turn += 1;
        document.getElementById('turnValue').textContent = turn;
        
        iaActionCount = 0;
        maneuverUsed = false;
        cityUsed = false; 
        firstCombatActionPlayed = false;
        combatActionHistory = []; 
        iaInitiatedCombat = false; 
        appActionHistory = []; 
        actionsUntilForcedPass = -1; 
        
        document.querySelector('.combat-titles-row').style.display = 'none';
        document.querySelector('.combat-flex-row').style.display = 'block';
        document.getElementById('endCombatBtn').style.display = 'none';
        document.getElementById('endCombatBtn').disabled = false; 

        document.getElementById('actionBtn').disabled = false; 
        document.getElementById('declareCombatBtn').disabled = false; 
        updateActionButton();
        
        document.getElementById('actionResult').innerHTML = `<p>Tour ${turn} !</p>`;
        document.getElementById('actionResult').classList.remove('combat-alert');
        document.getElementById('actionResult').style.backgroundColor = "#2c3e50";
        document.getElementById('actionResult').style.color = "#f0f0f0";
        document.getElementById('combatModule').style.display = 'none';
        
        document.getElementById('combatActionPlayed').innerHTML = `<p>Clique ci-dessous</p><button id="combatBtn" onclick="performCombatAction()" disabled>CAPACIT√â DE COMBAT</button>`;
    }

    function resetGame() {
        updateGold(0 - gold);
        updatePrestige(0 - prestige);
        
        turn = 0;
        nextTurn();
        appActionHistory = []; 
        actionsUntilForcedPass = -1; 
        
        document.getElementById('actionResult').innerHTML = "<p>Jeu r√©initialis√© ! tour 1.</p>";
        document.getElementById('actionResult').classList.remove('combat-alert'); 
        document.getElementById('actionResult').style.backgroundColor = "#5cb85c";
        document.getElementById('actionResult').style.color = "white"; 
        
        document.getElementById('combatModule').style.display = 'none';
        document.getElementById('endCombatBtn').style.display = 'none';
        document.getElementById('endCombatBtn').disabled = false; 
        
        document.querySelector('.combat-titles-row').style.display = 'none';
        document.querySelector('.combat-flex-row').style.display = 'block';
    }
    
    function performCombatAction() {
        document.getElementById('combatBtn').disabled = true; 

        let currentCombatActions = [...combatActions];
        const interceptorAction = "J'active un intercepteur s'il j'en ai un redress√© en jeu (si pas, je passe).";

        if (iaInitiatedCombat || firstCombatActionPlayed) {
             const interceptorIndex = currentCombatActions.indexOf(interceptorAction);
             if (interceptorIndex > -1) {
                 currentCombatActions.splice(interceptorIndex, 1);
             }
        }
        
        if (combatActionHistory.length >= 2) {
            const lastAction = combatActionHistory[0];
            const secondLastAction = combatActionHistory[1];

            if (lastAction === secondLastAction) {
                const actionToAvoid = lastAction;
                
                // Filtre pour √©viter la r√©p√©tition de la m√™me action 3 fois de suite (sauf si c'est la seule)
                currentCombatActions = currentCombatActions.filter(action => action !== actionToAvoid);

                // Si toutes les options valides sont √©puis√©es, on doit forc√©ment passer
                if (currentCombatActions.length === 0) {
                     currentCombatActions.push("Je passe."); 
                }
            }
        }


        let selectedAction = "Impossible de d√©terminer une action (r√®gles de restriction).";
        if (currentCombatActions.length > 0) {
            const randomIndex = Math.floor(Math.random() * currentCombatActions.length);
            selectedAction = currentCombatActions[randomIndex];
        }
        
        if (selectedAction !== "Impossible de d√©terminer une action (r√®gles de restriction).") {
            combatActionHistory.unshift(selectedAction);
            if (combatActionHistory.length > 2) {
                combatActionHistory.pop();
            }
        }

        if (!firstCombatActionPlayed) {
             document.getElementById('endCombatBtn').disabled = false;
        }

        firstCombatActionPlayed = true; 

        // --- Mise √† jour de la colonne de combat (droite) : Action de l'IA minimaliste ---
        document.getElementById('combatActionPlayed').innerHTML = 
            `<p><strong>üí• ${selectedAction}</strong></p>
            <button id="combatBtn" onclick="performCombatAction()" disabled>CAPACIT√â DE COMBAT</button>`; 
        
        // --- Mise √† jour de la colonne de l'action (gauche) : Ton tour ---
        document.getElementById('actionResult').innerHTML = 
            `<p style="font-size: 1.2em;">TON TOUR DE R√âPONSE.</p>`;
        
        document.getElementById('endCombatBtn').style.display = 'block';
        document.getElementById('endCombatBtn').disabled = false;
    }

    function performAppAction() {
        iaActionCount++;

        if (gold === 0 && actionsUntilForcedPass === -1) {
            actionsUntilForcedPass = 3; 
        }

        let dynamicActions = [];
        let totalWeight = 0;

        for (const action in baseActions) {
            
            if (action === "je passe." && iaActionCount < 5) {
                continue;
            }
            
            if (action === "Je joue une carte personnage/attachement." && gold === 0) {
                continue; 
            }

            dynamicActions.push({ action: action, weight: baseActions[action] });
            totalWeight += baseActions[action];
        }
        
        // LOGIQUE D'AJOUT DES ACTIONS MANOEUVRE ET CIT√â AVEC CONTRAINTE UNE FOIS PAR TOUR
        if (!maneuverUsed) {
            dynamicActions.push({ action: "J'active la capacit√© Action de ma manoeuvre si elle en poss√®de une.", weight: 3 });
            totalWeight += 3;
        }

        if (!cityUsed) {
            dynamicActions.push({ action: "J'active la capacit√© action de ma cit√© si elle en poss√®de une.", weight: 3 });
            totalWeight += 3;
        }
        // FIN LOGIQUE D'AJOUT

        
        if (actionsUntilForcedPass >= 0) {
            const forcedPassAction = "Je passe d√©finitivement";
            
            dynamicActions = dynamicActions.filter(item => item.action !== "Je d√©clare un combat !");
            dynamicActions = dynamicActions.filter(item => item.action !== forcedPassAction);

            if (actionsUntilForcedPass === 1) { 
                 dynamicActions = [];
                 dynamicActions.push({ action: forcedPassAction, weight: 1000 }); 
                 totalWeight = 1000;
            } else {
                const passWeight = 15; 
                dynamicActions.push({ action: forcedPassAction, weight: passWeight });
                
                totalWeight = dynamicActions.reduce((sum, item) => sum + item.weight, 0); 
            }
        }

        if (actionsUntilForcedPass === -1 && iaActionCount >= 10) {
            dynamicActions.push({ action: "Je passe d√©finitivement", weight: 2 });
            totalWeight += 2;
        }
        
        if (appActionHistory.length >= 2) {
            const lastAction = appActionHistory[0];
            const secondLastAction = appActionHistory[1];

            if (lastAction === secondLastAction) { 
                const actionToAvoid = lastAction;
                
                dynamicActions = dynamicActions.filter(item => item.action !== actionToAvoid);

                totalWeight = dynamicActions.reduce((sum, item) => sum + item.weight, 0); 
                
                 if (totalWeight === 0) {
                    if (actionsUntilForcedPass === 1) {
                         dynamicActions = [{ action: "Je passe d√©finitivement", weight: 1000 }];
                         totalWeight = 1000;
                    } else {
                        dynamicActions.push({ action: "je passe.", weight: 1 });
                        totalWeight = 1;
                    }
                 }
            }
        }

        let randomNum = Math.random() * totalWeight;
        let selectedAction = "";

        for (const item of dynamicActions) {
            randomNum -= item.weight;
            if (randomNum < 0) {
                selectedAction = item.action;
                break;
            }
        }
        
        // D√âCLENCHEMENT DU DRAPEAU POUR LA CONTRAINTE UNE FOIS PAR TOUR
        if (selectedAction.includes("manoeuvre")) {
            maneuverUsed = true;
        } else if (selectedAction.includes("cit√©")) {
            cityUsed = true;
        }
        
        if (selectedAction !== "Je passe d√©finitivement" && selectedAction !== "Impossible de d√©terminer une action (r√®gles de restriction).") {
            appActionHistory.unshift(selectedAction);
            if (appActionHistory.length > 2) {
                appActionHistory.pop();
            }
        }
        
        if (actionsUntilForcedPass > 0) {
            actionsUntilForcedPass--;
        }

        if (selectedAction === "Je passe d√©finitivement") {
            document.getElementById('actionBtn').textContent = "TOUR DE L'ADVERSAIRE VIRTUEL TERMIN√â";
            document.getElementById('actionBtn').disabled = true;
            actionsUntilForcedPass = -1; 
        }
        
        document.getElementById('combatModule').style.display = 'none';
        document.getElementById('endCombatBtn').style.display = 'none';
        document.getElementById('endCombatBtn').disabled = false; 
        document.querySelector('.combat-titles-row').style.display = 'none';
        document.querySelector('.combat-flex-row').style.display = 'block';

        
        updateActionButton(); 

        if (selectedAction === "Je d√©clare un combat !") {
            startCombat('ia'); 

        } else {
            document.querySelector('.combat-flex-row').style.display = 'block';
            
            document.getElementById('actionResult').innerHTML = `<p>${selectedAction} (Action n¬∞${iaActionCount})</p>`;
            document.getElementById('actionResult').classList.remove('combat-alert');
            document.getElementById('actionResult').style.backgroundColor = "#2c3e50";
            document.getElementById('actionResult').style.color = "#f0f0f0";
            
            if (selectedAction === "Je passe d√©finitivement") {
                 document.getElementById('actionBtn').textContent = "TOUR DE L'ADVERSAIRE VIRTUEL TERMIN√â";
                 document.getElementById('actionBtn').disabled = true;
            }
        }
    }

    // Initialisation au chargement de la page
    updateGold(0);
    updatePrestige(0);
    nextTurn(); 
</script>

</body>
</html>
